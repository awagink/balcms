---
detect_relations: false

# ==============================================
# ROUTE

Route:
    inheritance:
        extends: Bal_Route
        type: simple

# ==============================================
# CONTENT

Content:
    inheritance:
        extends: Balcms_Content
        type: simple

ContentEvent:
    inheritance:
        extends: Balcms_ContentEvent
        type: simple

ContentProduct:
    inheritance:
        extends: Balcms_ContentProduct
        type: simple

ContentBook:
    inheritance:
        extends: Balcms_ContentBook
        type: simple

# ==============================================
# FILE

File:
    inheritance:
        extends: Bal_File
        type: simple


# ==============================================
# MESSAGES

Message:
    inheritance:
        extends: Balcms_Message
        type: simple


# ==============================================
# INVOICES

Invoice:
    inheritance:
        extends: Bal_Invoice
        type: simple


# ==============================================
# USERS

User:
    inheritance:
        extends: Balcms_User
        type: simple

# ==============================================
# PERMISSIONS

Role:
    inheritance:
        extends: Bal_Role
        type: simple
        
PermissionAndRole:
    inheritance:
        extends: Bal_PermissionAndRole
        type: simple
        
Permission:
    inheritance:
        extends: Bal_Permission
        type: simple

RoleAndUser:
    inheritance:
        extends: Bal_RoleAndUser
        type: simple

PermissionAndUser:
    inheritance:
        extends: Bal_PermissionAndUser
        type: simple
        

# ^ /users/balupton/Server/public_html/sites/balcms/application/data/schema/_schema.yml


# ==============================================
# BAL INVOICE

Bal_InvoiceItem:
    columns:
        id:
            type: integer(2)
            primary: true
            unsigned: true
            autoincrement: true
        title:
            type: string(50)
            notblank: true
        template:
            type: string(50)
            notblank: true
            default: "user_invoiceitem"
            extra:
                auto: true
                
        quantity:
            # the amount of items to have
            type: int(2)
            notblank: true
        payment_fee:
            # returned payment fee from gateway
            type: decimal(8)
            scale: 2
            notnull: true
            default: 0.00
            extra:
                currency: true
        weight_unit:
            # weight unit to use
            type: enum
            values: [kgs,lbs]
            default: kgs
            notblank: true
        
        
        price_each:
            # the price for each item		- Discount, Handling, Shipping, Tax
            type: decimal(8)
            scale: 2
            notnull: true
            extra:
                currency: true
        price_each_d:
            # the price for each item 	+ Discount
            type: decimal(8)
            scale: 2
            notnull: true
            extra:
                currency: true
        price_all_total:
            # the price for all  items	- Discount, Handling, Shipping, Tax
            type: decimal(8)
            scale: 2
            notnull: true
            extra:
                currency: true
        price_all_total_d:
            # the price for all  items	+ Discount
            type: decimal(8)
            scale: 2
            notnull: true
            extra:
                currency: true
        price_all_total_dhs:
            # the price for all  items	+ Discount, Handling, Shipping
            type: decimal(8)
            scale: 2
            notnull: true
            extra:
                currency: true
        price_total:
            # the price for all  items	+ Discount, Handling, Shipping, Tax
            type: decimal(8)
            scale: 2
            notnull: true
            extra:
                currency: true
        
        handling_each:
            # handling for each item
            type: decimal(8)
            scale: 2
            notnull: true
            default: 0.00
            extra:
                currency: true
        handling_all_total:
            # total handling for all items
            type: decimal(8)
            scale: 2
            notnull: true
            extra:
                currency: true
                
        tax_each:
            # tax for each item
            type: decimal(8)
            scale: 2
            notnull: true
            default: 0.00
            extra:
                currency: true
        tax_each_rate:
            # tax rate for each item
            type: decimal(8)
            scale: 2
            notnull: true
            default: 0.00
            extra:
                percentage: true
        tax_each_total:
            # total tax for each item
            type: decimal(8)
            scale: 2
            notnull: true
            extra:
                currency: true
        tax_all_total:
            # total tax for all items
            type: decimal(8)
            scale: 2
            notnull: true
            extra:
                currency: true
                
        weight_each:
            # weight for each item
            type: decimal(8)
            scale: 2
            notnull: true
            default: 0.00
        weight_all_total:
            # total weight for all times
            type: decimal(8)
            scale: 2
            notnull: true
            
        discount_each:
            # discount for each item
            type: decimal(8)
            scale: 2
            notnull: true
            default: 0.00
            extra:
                currency: true
        discount_each_rate:
            # discount rate for each item
            type: decimal(8)
            scale: 2
            notnull: true
            default: 0.00
            extra:
                percentage: true
        discount_each_total:
            # total discount for each item
            type: decimal(8)
            scale: 2
            notnull: true
            extra:
                currency: true
        discount_all_total:
            # total discount for all items
            type: decimal(8)
            scale: 2
            notnull: true
            extra:
                currency: true
                
        shipping_first:
            # shipping for first item
            type: decimal(8)
            scale: 2
            notnull: true
            default: 0.00
            extra:
                percentage: true
        shipping_additional:
            # shipping for each additional item
            type: decimal(8)
            scale: 2
            notnull: true
            extra:
                currency: true
        shipping_all_total:
            # total shipping for all items
            type: decimal(8)
            scale: 2
            notnull: true
            extra:
                currency: true
        
        Invoice_id:
            type: integer(2)
            unsigned: true
            notblank: true
    relations:
        Invoice:
            class: Invoice
            local: Invoice_id
            foreign: id
            foreignAlias: InvoiceItems
            foreignType: many
            onDelete: "CASCADE" # If Invoice is deleted, delete InvoiceItem

Bal_Invoice:
    actAs:
        Timestampable:
    columns:
        id:
            type: integer(2)
            primary: true
            unsigned: true
            autoincrement: true
        code:
            type: string(30)
            notblank: true
            unique: true
        title:
            type: string(50)
            notblank: true
        template:
            type: string(50)
            notblank: true
            default: "user_invoice"
            extra:
                auto: true
        status:
            type: enum
            values: [pending,published,completed]
            notblank: true
            default: published
        config:
            # Cache of any invoice configuration that may change externally
            # For example company name, tax amounts, commission rates etc
            type: array
        
        currency_code:
            type: string(3)
        paid_at:
            type: timestamp
        payment_status:
            # returned payment status from paypal
            type: enum
            values: [awaiting,created,pending,refunded,processed,completed,canceled_reversal,denied,expired,failed,voided,reversed]
            notblank: true
            default: awaiting
        payment_fee:
            # returned payment fee from gateway
            type: decimal(8)
            scale: 2
            notnull: true
            default: 0.00
            extra:
                currency: true
        payment_error:
            # returned payment error from gateway
            type: string(255)
        weight_unit:
            # weight unit to use
            type: enum
            values: [kgs,lbs]
            default: kgs
            notblank: true
        
        price_all_total:
            # the price for all  items	- Discount, Handling, Shipping, Tax
            type: decimal(8)
            scale: 2
            notnull: true
            extra:
                currency: true
        price_all_total_d:
            # the price for all  items	+ Discount
            type: decimal(8)
            scale: 2
            notnull: true
            extra:
                currency: true
        price_all_total_dhs:
            # the price for all  items	+ Discount, Handling, Shipping
            type: decimal(8)
            scale: 2
            notnull: true
            extra:
                currency: true
        price_total:
            # the price for all  items	+ Discount, Handling, Shipping, Tax
            type: decimal(8)
            scale: 2
            notnull: true
            extra:
                currency: true
        
        handling_all_total:
            # total handling for all items
            type: decimal(8)
            scale: 2
            notnull: true
            extra:
                currency: true
        tax_all_total:
            # total tax for all items
            type: decimal(8)
            scale: 2
            notnull: true
            extra:
                currency: true
        weight_all_total:
            # total weight for all times
            type: decimal(8)
            scale: 2
            notnull: true
            extra:
                currency: true
        discount_all_total:
            # total discount for all items
            type: decimal(8)
            scale: 2
            notnull: true
            extra:
                currency: true
        shipping_all_total:
            # total shipping for all items
            type: decimal(8)
            scale: 2
            notnull: true
            extra:
                currency: true
        
        File_id:
            type: integer(2)
            unsigned: true
        UserFor_id:
            type: integer(2)
            unsigned: true
        UserFrom_id:
            type: integer(2)
            unsigned: true
    relations:
        File:
            class: File
            local: File_id
            foreign: id
            foreignAlias: Invoices
            foreignType: many
            onDelete: "SET NULL" # If File is deleted, set null
        UserFor:
            class: User
            local: UserFor_id
            foreign: id
            foreignAlias: InvoicesFor
            onDelete: "SET NULL" # If UserFor is deleted, set null
        UserFrom:
            class: User
            local: UserFrom_id
            foreign: id
            foreignAlias: InvoicesFrom
            onDelete: "SET NULL" # If UserFrom is deleted, set null


InvoiceDataBackup:
    actAs:
        Timestampable:
    columns:
        id:
            type: integer(2)
            primary: true
            unsigned: true
            autoincrement: true
        data:
            type: array
            notnull: true
        Invoice_id:
            type: integer(2)
            unsigned: true
    relations:
        Invoice:
            class: Invoice
            local: Invoice_id
            foreign: id
            #foreignAlias: InvoiceDataBackups
            foreignType: many
            onDelete: "CASCADE" # If Invoice is deleted, delete InvoiceDataBackup



# ^ /users/balupton/Server/public_html/sites/balcms/application/models/Bal/Schema/Invoice.yaml


# ==============================================
# BAL MEDIA

Bal_File:
    actAs:
        Sluggable:
            name: code
            canUpdate: true
            fields: [name]
        Bal_Doctrine_Template_Auditable:
            Author:
                disabled: false
            created_at:
                disabled: false
            updated_at:
                disabled: false
        Searchable:
            fields: [code,title,path,type]
    columns:
        id:
            primary: true
            type: integer(2)
            unsigned: true
            autoincrement: true
        name:
            type: string(255)
            notblank: true
            unique: true
        title:
            type: string(255)
            notblank: true
        extension:
            type: string(3)
            notnull: true
        path:
            type: string(255)
            notblank: true
        size:
            type: integer(4)
            notnull: true
        type:
            type: enum
            values: [file,document,image,video,audio,web,application,archive]
            default: unknown
            notblank: true
        mimetype:
            type: string(40)
            notnull: true
        humantype:
            type: string(50)
            notnull: true
        width:
            type: integer(2)
            unsigned: true
        height:
            type: integer(2)
            unsigned: true
        url: #auto
            type: string(255)


# ^ /users/balupton/Server/public_html/sites/balcms/application/models/Bal/Schema/File.yaml


# ==============================================
# BAL MESSAGE

Bal_Message:
    columns:
        id:
            type: integer(3)
            unsigned: true
            primary: true
            autoincrement: true
        send_on:
            type: timestamp
            notblank: true
        sent_on:
            type: timestamp
            extra:
                auto: true
        title:
            type: string(255)
            notblank: true
        description:
            type: string
            notblank: true
            extra:
                html: true
        unread:
            type: boolean
            default: true
            notnull: true
            extra:
                auto: true
        hash:
            type: string(33)
            unique: true
            notblank: true
            extra:
                auto: true
        
        status:
            type: enum
            notblank: true
            values: [pending,published]
            default: pending
            extra:
                auto: true
        template:
            type: string(30)
            notblank: true
            default: "user_message"
            extra:
                auto: true
        MessageParent_id:
            type: integer(3)
            unsigned: true
        UserFor_id:
            type: integer(2)
            unsigned: true
        UserFrom_id:
            type: integer(2)
            unsigned: true
    relations:
        MessageParent:
            # Which Message is this Message for?
            class: Message
            local: MessageParent_id
            foreign: id
            foreignAlias: MessagesChild
            onDelete: "CASCADE" # If MessageParent is deleted, cascade
        UserFor:
            class: User
            local: UserFor_id
            foreign: id
            foreignAlias: MessagesFor
            onDelete: "CASCADE" # If UserFor is deleted, cascade
        UserFrom:
            class: User
            local: UserFrom_id
            foreign: id
            foreignAlias: MessagesFrom
            onDelete: "CASCADE" # If UserFrom is deleted, cascade
    

# ^ /users/balupton/Server/public_html/sites/balcms/application/models/Bal/Schema/Message.yaml


# ==============================================
# BAL ROUTE

Bal_Route:
    actAs:
        SoftDelete:
        Searchable:
            fields: [path]
    columns:
        id:
            primary: true
            type: integer(2)
            unsigned: true
            autoincrement: true
        path:
            type: string(150)
            notblank: true
            unique: true
        type:
            type: string(15)
            notblank: true
        data:
            type: array


# ^ /users/balupton/Server/public_html/sites/balcms/application/models/Bal/Schema/Route.yaml


# ==============================================
# BAL USER

Bal_User:
    actAs:
        Sluggable:
            name: code
            canUpdate: true
            fields: [username]
        Taggable:
            tagAlias: "SubscriptionTags"
        Timestampable:
        Bal_Doctrine_Template_Addressable:
            # This can only be listed once due to bug in doctrine
    columns:
        id:
            type: integer(2)
            unsigned: true
            primary: true
            autoincrement: true
        username:
            type: string(16)
            notblank: true
            unique: true
        password:
            # md5 hash
            type: string(33)
            notblank: true
            extra:
                password: true
        displayname:
            # The Name to Display the User As
            type: string(85)
            notblank: true
            
        title:
            type: string(15)
        firstname:
            type: string(35)
        lastname:
            type: string(35)
        fullname:
            type: string(85)
            extra:
                auto: true
        website:
            type: string(255)
            extra:
                website: true
        paypal:
            type: string(255)
            extra:
                email: true
            
        email:
            type: string(255)
            notblank: true
            #email: true
            extra:
                email: true
        phone:
            type: string(255)
            extra:
                phone: true
            
        description:
            # Bio
            type: string
            extra:
                html: html
        
        level:
            # Permission Level - Calculated by highest role
            type: integer(1)
            unsigned: true
            notnull: true
            default: 0
            extra:
                auto: true
        subscriptions:
            # CSV generated from SubscriptionTags. Used for searchable.
            type: string(255)
            extra:
                csv: true
        code:
            # Alias for Username
            type: string(33)
            notblank: true
            unique: true
            extra:
                auto: true
        uid:
            # Unique Identifier for the User
            type: string(33)
            notblank: true
            unique: true
            extra:
                auto: true
        type:
            type: enum
            values: [user]
            notblank: true
        status:
            type: enum
            values: [pending,published,disabled]
                # pending - Awaiting activation
                # published - Activated
                # disabled - Disabled for whatever reason
            notblank: true
            default: pending
        
        locale:
            type: string(6)
        language:
            type: string(6)
        charset:
            type: string(30)
        timezone:
            type: string(30)
        currency:
            type: string(6)
        
        Avatar_id:
            type: integer(2)
            unsigned: true
    relations:
        Avatar:
            class: File
            local: Avatar_id
            foreign: id
            foreignAlias: UserList
            onDelete: "SET NULL" # If Avatar is deleted, set to null
        Permissions:
            class: Permission
            local: User_id
            foreign: Permission_id
            foreignAlias: Users
            refClass: PermissionAndUser
            onDelete: "NO ACTION" # If User is deleted, don't do anything to the Permissions
        Roles:
            class: Role
            local: User_id
            foreign: Role_id
            foreignAlias: Users
            refClass: RoleAndUser
            onDelete: "NO ACTION" # If User is deleted, don't do anything to the Roles

# ==============================================
# BAL PERMISSIONS

Bal_Role:
    columns:
        id:
            type: integer(2)
            primary: true
            autoincrement: true
            unsigned: true
            autoincrement: true
        code:
            type: string(15)
            notblank: true
            unique: true
        level:
            type: integer(1)
            notblank: true
            unsigned: true
            default: 1
    relations:
        Permissions:
            class: Permission
            local: Role_id
            foreign: Permission_id
            foreignAlias: Roles
            refClass: PermissionAndRole
            onDelete: "NO ACTION" # If Role is deleted, don't do anything to the Permissions

Bal_PermissionAndRole:
    columns:
        id:
            type: integer(2)
            primary: true
            unsigned: true
            autoincrement: true
        Role_id:
            type: integer(2)
            unsigned: true
            notnull: true
        Permission_id:
            type: integer(2)
            unsigned: true
            notnull: true
    relations:
        Role:
            local: Role_id
            foreign: id
            onDelete: "CASCADE" # If Role is deleted, delete reference
        Permission:
            local: Permission_id
            foreign: id
            onDelete: "CASCADE" # If Permission is deleted, delete reference
        
Bal_Permission:
    columns:
        id:
            type: integer(2)
            primary: true
            unsigned: true
            autoincrement: true
        code:
            type: string(50)
            notblank: true
            unique: true

Bal_RoleAndUser:
    columns:
        id:
            type: integer(2)
            primary: true
            unsigned: true
            autoincrement: true
        assigned_date:
            type: timestamp
            notnull: false
            
        UserFrom_id:
            type: integer(2)
            unsigned: true
        User_id:
            type: integer(2)
            notnull: true
            unsigned: true
        Role_id:
            type: integer(2)
            notnull: true
            unsigned: true
    relations:
        UserFrom:
            class: User
            local: UserFrom_id
            foreign: id
            onDelete: "SET NULL" # If UserFrom is deleted, set to null
        User:
            local: User_id
            foreign: id
            onDelete: "CASCADE" # If User is deleted, delete reference
        Role:
            local: Role_id
            foreign: id
            onDelete: "CASCADE" # If Role is deleted, delete reference

Bal_PermissionAndUser:
    columns:
        id:
            type: integer(3)
            primary: true
            unsigned: true
            autoincrement: true
        assigned_date:
            type: timestamp
            notnull: false
            
        UserFrom_id:
            type: integer(2)
            notnull: false
            unsigned: true
        User_id:
            type: integer(2)
            notnull: true
            unsigned: true
        Permission_id:
            type: integer(2)
            notnull: true
            unsigned: true
    relations:
        UserFrom:
            class: User
            local: UserFrom_id
            foreign: id
            onDelete: "SET NULL" # If UserFrom is deleted, set to null
        User:
            local: User_id
            foreign: id
            onDelete: "CASCADE" # If User is deleted, delete reference
        Permission:
            local: Permission_id
            foreign: id
            onDelete: "CASCADE" # If Permission is deleted, delete reference


# ^ /users/balupton/Server/public_html/sites/balcms/application/models/Bal/Schema/User.yaml


# ==============================================
# BALCMS CONTENT

Balcms_Content:
    actAs:
        SoftDelete:
        Bal_Doctrine_Template_Auditable:
            status:
                disabled: false
            Author:
                disabled: false
            authorstr:
                disabled: false
            created_at:
                disabled: false
            updated_at:
                disabled: false
            published_at:
                disabled: false
        Searchable:
            fields: [code, tags, authorstr, title, description]
        Taggable:
            tagAlias: "ContentTags"
    columns:
        id:
            primary: true
            type: integer(2)
            unsigned: true
            autoincrement: true
        code:
            type: string(30)
            notblank: true
            unique: true
        title:
            type: string(50)
            notblank: true
        tagline:
            type: string(100)
        description:
            type: string
            notblank: true
            extra:
                html: raw
        description_rendered:
            type: string
            notblank: true
            extra:
                html: raw #handled explicity inside now
                auto: true
        description_useauto:
            type: bool
            notnull: true
            extra:
                auto: true
        tags:
            type: string(255)
        content:
            type: string
            notblank: true
            extra:
                html: raw
        content_rendered:
            type: string
            notblank: true
            extra:
                html: raw #handled explicity inside now
                auto: true
        last_refreshed: # When was the content's cache last refreshed
            type: timestamp
            
        position:
            type: integer(2)
            unsigned: true
            notnull: true
            default: 0
        type:
            type: enum
            values: [content,event]
            default: content
            notblank: true
            extra:
                auto: true
        comments_enabled:
            type: bool
            notnull: true
            default: true
            
        Avatar_id:
            type: integer(2)
            unsigned: true
        Route_id:
            type: integer(2)
            unsigned: true
            unique: true
        Parent_id:
            type: integer(2)
            unsigned: true
    relations:
        Avatar:
            class: File
            local: Avatar_id
            foreign: id
            foreignAlias: Contents
            onDelete: "SET NULL"
        Route:
            local: Route_id
            foreign: id
            foreignAlias: Contents
            onDelete: CASCADE
        Parent:
            class: Content
            local: Parent_id
            foreign: id
            foreignAlias: Children
            onDelete: CASCADE

Balcms_ContentProduct:
    inheritance:
        extends: Content
        type: column_aggregation
        keyField: type
        keyValue: product
    columns:
        product_cost:
            type: decimal(8)
            scale: 2
            #notblank: true
            extra:
                currency: true
        product_taxable:
            type: boolean
            default: true
        product_stock:
            type: integer(2)
            unsigned: true
            #notnull: true

Balcms_ContentBook:
    inheritance:
        extends: ContentProduct
        type: column_aggregation
        keyField: type
        keyValue: book
    columns:
        book_isbn:
            # Unique Identifier
            type: string(13)
        book_isn:
            # Before ISBN
            type: string(8)
        book_author:
            type: string(50)
            #notblank: true
        book_published:
            type: timestamp
        book_publisher:
            type: string(50)
        book_binding:
            type: enum
            values: [hardcover,softcover]
        book_edition:
            type: string(10)
        book_quality:
            type: enum
            values: [used,new,good]

Balcms_ContentEvent:
    inheritance:
        extends: Content
        type: column_aggregation
        keyField: type
        keyValue: event
    columns:
        event_start_at:
            type: timestamp
        event_finish_at:
            type: timestamp

# ==============================================
# BALCMS MESSAGE

Balcms_Message:
    inheritance:
        extends: Bal_Message
        type: simple
    columns:
        content_id:
            type: integer(2)
            unsigned: true
    relations:
        Content:
            class: Content
            local: Content_id
            foreign: id
            foreignAlias: Messages


# ==============================================
# BALCMS USER

Balcms_User:
    inheritance:
        extends: Bal_User
        type: simple
    actAs:
        Searchable:
            fields: [username,email,fullname,suburb,state,country]
            # This can only be listed once due to bug in doctrine
    columns:
        type:
            type: enum
            values: [user]
            notblank: true
            default: "user"


# ^ /users/balupton/Server/public_html/sites/balcms/application/models/Balcms/Schema/Schema.yaml

